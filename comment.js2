javascript:(function(){const users={};function addUser(id,username){users[id]=username}const studioId=window.location.href.split('/')[4];const parentComments="https://api.scratch.mit.edu/studios/"+studioId+"/comments";const element=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2)");let originalPostButton;if(element){element.style.display="none";const parent=element.parentNode;const newDiv=document.createElement("div");newDiv.id="comment-section-placeholder";parent.appendChild(newDiv)}createCommentStructure();fetchAndAppendParentComments();let updateInterval;function initRealTimeCommentUpdate(){updateInterval=setInterval(()=>{fetchAndAppendParentComments();updateOpenReplies();updateAllRelativeTimes()},1000);}initRealTimeCommentUpdate();function createCommentStructure(){const parentElement=document.querySelector("#comment-section-placeholder");if(!parentElement) return;const uniqueId=`frc-compose-comment-${Date.now()}`;const originalIcon=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div > div > a");let href="#", imgSrc="#";if(originalIcon){href=originalIcon.getAttribute("href")||"#";imgSrc=originalIcon.querySelector("img")?.getAttribute("src")||"#"}const newComment=document.createElement("div");newComment.classList.add("comments-root-reply");newComment.innerHTML=`<div class="flex-row comment compose-row"><a href="${href}"><img class="avatar" src="${imgSrc}" alt="User Icon"></a><div class="flex-row compose-comment column"><form class="full-width-form"><div class="form-group row textarea-row no-label compose-input compose-valid"><div class="col-sm-offset-3 col-sm-9 grow"><textarea class="inplace-textarea" name="compose-comment" id="${uniqueId}" rows="3"></textarea></div></div><div class="flex-row compose-bottom-row"><button class="button compose-post"><span>投稿する</span></button><button class="button compose-cancel"><span>キャンセル</span></button><span class="compose-limit compose-valid"><span></span></span></div></form></div></div>`;parentElement.appendChild(newComment);const customTextarea=newComment.querySelector("textarea");const originalTextarea=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div.comments-root-reply > div > div > form textarea.inplace-textarea");const postButton=newComment.querySelector(".button.compose-post");originalPostButton=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div.comments-root-reply > div > div > form > div.flex-row.compose-bottom-row > button.button.compose-post");if(customTextarea && originalTextarea){customTextarea.addEventListener("input",()=>{originalTextarea.value=customTextarea.value;originalTextarea.dispatchEvent(new Event("input",{bubbles:true}));originalTextarea.dispatchEvent(new Event("change",{bubbles:true}));});}if(postButton && originalPostButton){postButton.addEventListener("click",(event)=>{event.preventDefault();if(!customTextarea.value.trim()){showEmptyError(newComment);return;}const existingError=newComment.querySelector(".compose-error-row");if(existingError) existingError.remove();handlePostButtonClick(postButton,originalPostButton,newComment,customTextarea);originalPostButton.click();});}applyAvatarSizeFix();}function showEmptyError(form){const errorDiv=document.createElement("div");errorDiv.classList.add("compose-error-row");errorDiv.innerHTML=`<span>空のコメントは投稿できません</span>`;form.querySelector(".full-width-form").prepend(errorDiv);setTimeout(()=>errorDiv.remove(),5000);}function applyAvatarSizeFix(){const style=document.createElement('style');style.textContent=`img.avatar {width: 40px !important;height: 40px !important;object-fit: cover !important;}`;document.head.appendChild(style);}function handlePostButtonClick(postButton,originalPostButton,newComment,customTextarea){if(!postButton||!originalPostButton) return;clearInterval(updateInterval);postButton.querySelector("span").textContent="投稿中...";postButton.disabled=true;let a=0;const interval=setInterval(()=>{if(originalPostButton.textContent.includes("...")){a=1}else if(a===1){postButton.querySelector("span").textContent="投稿する";postButton.disabled=false;fetchAndAppendParentComments();updateOpenReplies();updateAllRelativeTimes();initRealTimeCommentUpdate();clearInterval(interval);handleErrorMessages(newComment,originalPostButton,customTextarea);}},1);}function handleErrorMessages(newComment,originalPostButton,customTextarea){setTimeout(()=>{const parentLevel3=originalPostButton?.parentElement?.parentElement?.parentElement;let errorExists=false;if(parentLevel3&&parentLevel3.children.length===2){const originalErrorMessage=parentLevel3.children[0];if(originalErrorMessage.classList.contains("compose-error-row")){const errorClone=originalErrorMessage.cloneNode(true);newComment.querySelector(".full-width-form").prepend(errorClone);errorExists=true;}}if(!errorExists){if(newComment.classList.contains("comment-reply-row")){newComment.remove()}else{if(customTextarea){customTextarea.value="";}}}},1000);}function toggleReplyFormForComment(commentElement){document.querySelectorAll('.comment-reply-row').forEach(form=>form.remove());const replyFormId='reply-form-'+commentElement.id;if(document.getElementById(replyFormId)) return;const originalIcon=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div div > a");let replyHref="#", replyImgSrc="#";if(originalIcon){replyHref=originalIcon.getAttribute("href")||"#";replyImgSrc=originalIcon.querySelector("img")?.getAttribute("src")||"#"}const replyForm=document.createElement('div');replyForm.classList.add('flex-row','comment-reply-row');replyForm.id=replyFormId;replyForm.innerHTML=`<div class="flex-row comment compose-row"><a href="${replyHref}"><img class="avatar" src="${replyImgSrc}" alt="User Icon"></a><div class="flex-row compose-comment column"><form class="full-width-form"><div class="form-group row textarea-row no-label compose-input compose-valid"><div class="col-sm-offset-3 col-sm-9 grow"><textarea class="inplace-textarea" name="compose-comment" rows="3"></textarea></div></div><div class="flex-row compose-bottom-row"><button type="button" class="button compose-post"><span>投稿する</span></button><button type="button" class="button compose-cancel"><span>キャンセル</span></button><span class="compose-limit compose-valid"><span></span></span></div></form></div></div>`;const cancelButton=replyForm.querySelector(".compose-cancel");if(cancelButton){cancelButton.addEventListener("click",(e)=>{e.preventDefault();replyForm.remove()})}const customTextarea=replyForm.querySelector("textarea");const originalTextarea=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div.comments-root-reply > div > div > form textarea.inplace-textarea");if(customTextarea && originalTextarea){customTextarea.addEventListener("input",()=>{originalTextarea.value=customTextarea.value;originalTextarea.dispatchEvent(new Event("input",{bubbles:true}));originalTextarea.dispatchEvent(new Event("change",{bubbles:true}));});}const postButton=replyForm.querySelector(".compose-post");if(postButton && originalPostButton){postButton.addEventListener("click",(e)=>{e.preventDefault();if(!customTextarea.value.trim()){showEmptyError(replyForm);return;}const existingError=replyForm.querySelector(".compose-error-row");if(existingError) existingError.remove();handlePostButtonClick(postButton,originalPostButton,replyForm,customTextarea);originalPostButton.click();});}const commentBody=commentElement.querySelector(".comment-body");const commentBubble=commentBody.querySelector(".comment-bubble");if(commentBubble){commentBubble.parentNode.insertBefore(replyForm,commentBubble.nextSibling)}else{commentBody.appendChild(replyForm)}autoFocusReplyInput(replyForm);applyAvatarSizeFix();}function renderAppendedComment(comment){addUser(comment.author.id,comment.author.username);const container=document.createElement("div");container.classList.add("flex-row","comment-container");const commentElement=document.createElement("div");commentElement.classList.add("flex-row","comment");commentElement.id="appended-comment-"+comment.id;commentElement.dataset.commentId=comment.id;commentElement.dataset.commentAuthor=comment.author.id;const userLink=document.createElement("a");userLink.href="/users/"+comment.author.username;const avatar=document.createElement("img");avatar.classList.add("avatar");avatar.src=comment.author.image;avatar.alt=comment.author.username;userLink.appendChild(avatar);const commentBody=document.createElement("div");commentBody.classList.add("flex-row","comment-body","column");const commentTopRow=document.createElement("div");commentTopRow.classList.add("flex-row","comment-top-row");const usernameLink=document.createElement("a");usernameLink.classList.add("username");usernameLink.href="/users/"+comment.author.username;usernameLink.textContent=comment.author.username;commentTopRow.appendChild(usernameLink);const commentBubble=document.createElement("div");commentBubble.classList.add("comment-bubble");const commentContent=document.createElement("span");commentContent.classList.add("comment-content");const emojiText=document.createElement("span");emojiText.classList.add("emoji-text");emojiText.innerHTML=linkify(decodeHTMLEntities(comment.content));commentContent.appendChild(emojiText);commentBubble.appendChild(commentContent);const commentBottomRow=document.createElement("div");commentBottomRow.classList.add("flex-row","comment-bottom-row");const commentTime=document.createElement("span");commentTime.classList.add("comment-time");const timeSpan=document.createElement("span");timeSpan.dataset.timestamp=comment.datetime_created;timeSpan.textContent=formatRelativeTime(comment.datetime_created);timeSpan.dataset.type="date";commentTime.appendChild(timeSpan);const linkSpan=document.createElement("span");linkSpan.textContent="リンク";linkSpan.style.marginLeft="8px";linkSpan.style.cursor="pointer";linkSpan.style.color="#855cd6";linkSpan.addEventListener("click",()=>{window.open(`/studios/${studioId}/comments/#comments-${comment.id}`,'_blank')});const replyConfirmText=document.createElement("a");replyConfirmText.textContent="返信を確認";replyConfirmText.style.cursor="pointer";replyConfirmText.style.color="#855cd6";replyConfirmText.addEventListener("click",()=>toggleReplies(commentElement));const replyCount=document.createElement("span");replyCount.classList.add("reply-count");if(comment.reply_count)replyCount.style.fontWeight="bolder";const replyCountOpen=document.createElement("span");replyCountOpen.innerText="(";const replyCounter=document.createElement("span");replyCounter.classList.add("reply-counter");replyCounter.innerText=comment.reply_count;const replyCountClose=document.createElement("span");replyCountClose.innerText=")　";replyCount.appendChild(replyCountOpen);replyCount.appendChild(replyCounter);replyCount.appendChild(replyCountClose);const commentReply=document.createElement("span");commentReply.classList.add("comment-reply");commentReply.innerHTML="返信";commentReply.style.cursor="pointer";commentReply.style.color="#855cd6";commentReply.addEventListener("click",(e)=>{e.preventDefault();toggleReplyFormForComment(commentElement)});const right=document.createElement("span");commentBottomRow.appendChild(commentTime);commentBottomRow.appendChild(right);right.appendChild(linkSpan);right.appendChild(replyConfirmText);right.appendChild(replyCount);right.appendChild(commentReply);commentBubble.appendChild(commentBottomRow);commentBody.appendChild(commentTopRow);commentBody.appendChild(commentBubble);commentElement.appendChild(userLink);commentElement.appendChild(commentBody);container.appendChild(commentElement);return container;}function fetchAndAppendParentComments(){const limit=20;const url=parentComments+`?limit=${limit}`;fetch(url).then(r=>r.json()).then(comments=>{for(let i=comments.length-1;i>=0;i--){const c=comments[i];const id="appended-comment-"+c.id;if(!document.getElementById(id)){const el=renderAppendedComment(c);const ph=document.getElementById("comment-section-placeholder");if(ph.children.length>=1){ph.insertBefore(el,ph.children[1]);}else{ph.appendChild(el);}}}});}let openReplies=[];function toggleReplies(el){const pid=el.dataset.commentId;const rid="replies-container-"+pid;let rc=document.getElementById(rid);if(rc){rc.remove();openReplies=openReplies.filter(x=>x.id!==rid);return;}fetch(parentComments+`/${pid}/replies?limit=25`).then(r=>r.json()).then(rs=>{rc=document.createElement("div");rc.classList.add("flex-row","replies","column");rc.id=rid;rs.forEach(rep=>rc.appendChild(renderReplyComment(rep)));el.parentNode.appendChild(rc);openReplies.push(rc);if(openReplies.length>20)openReplies.shift().remove();applyAvatarSizeFix();});}function renderReplyComment(reply){addUser(reply.author.id,reply.author.username);const container=document.createElement("div");container.classList.add("flex-row","comment");container.id="comments-"+reply.id;container.dataset.commentAuthor=reply.author.id;container.innerHTML=`<a href="/users/${reply.author.username}/"><img class="avatar" src="${reply.author.image}"></a><div class="flex-row comment-body column"><div class="flex-row comment-top-row"><a class="username" href="/users/${reply.author.username}/">${reply.author.username}</a></div><div class="comment-bubble"><span class="comment-content"><a href="/users/${users[reply.commentee_id]||''}" style="color:#855cd6;">@${users[reply.commentee_id]||''}</a><span class="emoji-text">${linkify(decodeHTMLEntities(reply.content))}</span></span><div class="flex-row comment-bottom-row"><span class="comment-time"><span data-timestamp="${reply.datetime_created}" data-type="date">${formatRelativeTime(reply.datetime_created)}</span></span><span style="margin-left:8px;cursor:pointer;color:#855cd6;" onclick="window.open('/studios/${studioId}/comments/#comments-${reply.id}','_blank')">リンク</span><span style="cursor:pointer;color:#855cd6;" onclick="toggleReplyFormForReply(this.closest('.comment'))">返信</span></div></div></div>`;return container;}function toggleReplyFormForReply(el){const parent=el.parentNode.parentNode.parentNode.parentNode.parentNode.firstElementChild;toggleReplyFormForComment(parent);}function updateOpenReplies(){openReplies.forEach(c=>{const pid=c.id.split("-").pop();fetch(parentComments+"/"+pid+"/replies?limit=25").then(r=>r.json()).then(rs=>{rs.forEach(rep=>{if(!c.querySelector("#comments-"+rep.id)){c.appendChild(renderReplyComment(rep));}})});}function updateAllRelativeTimes(){document.querySelectorAll("[data-type=date]").forEach(e=>e.textContent=formatRelativeTime(e.dataset.timestamp));}function decodeHTMLEntities(t){const ta=document.createElement("textarea");ta.innerHTML=t;return ta.value;}function formatRelativeTime(ts){const now=new Date();const d=new Date(ts);let diff=(now-d)/1000;if(diff<60)return diff<1?"今":Math.floor(diff)+"秒前";diff/=60;if(diff<60)return Math.floor(diff)+"分前";diff/=60;if(diff<24)return Math.floor(diff)+"時間前";diff/=24;if(diff<30)return Math.floor(diff)==1?"昨日":Math.floor(diff)+"日前";return "1ヶ月以上前";}function linkify(t){return t.replace(/(https?:\/\/[^\s<>"']+)/g,'<a href="$1" target="_blank" style="color:#855cd6;text-decoration:underline;">$1</a>');}const COMMENTS_PER_LOAD=20;function addLoadMoreButtonSafe(){if(document.getElementById("load-more-btn"))return;const wrap=document.createElement("div");wrap.style.textAlign="center";wrap.style.margin="10px 0";const btn=document.createElement("button");btn.id="load-more-btn";btn.innerHTML="<span>もっと読み込む</span>";btn.style.background="#855cd6";btn.style.color="#fff";btn.style.border="none";btn.style.padding="8px 16px";btn.style.borderRadius="8px";btn.style.cursor="pointer";btn.onclick=loadMoreComments;wrap.appendChild(btn);document.getElementById("comment-section-placeholder").appendChild(wrap);}async function loadMoreComments(){const btn=document.getElementById("load-more-btn");if(!btn)return;const span=btn.querySelector("span");span.textContent="読み込み中...";btn.disabled=true;const offset=document.querySelectorAll('[id^="appended-comment-"]').length;const res=await fetch(parentComments+`?limit=${COMMENTS_PER_LOAD}&offset=${offset}`);const cs=await res.json();cs.forEach(c=>{if(!document.getElementById("appended-comment-"+c.id)){const el=renderAppendedComment(c);document.getElementById("comment-section-placeholder").appendChild(el);}});if(cs.length<COMMENTS_PER_LOAD){span.textContent="これ以上ありません";btn.disabled=true;}else{span.textContent="もっと読み込む";btn.disabled=false;}applyAvatarSizeFix();}setTimeout(addLoadMoreButtonSafe,100);applyAvatarSizeFix();})();
