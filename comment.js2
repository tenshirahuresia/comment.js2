javascript:(function(){const users={};function addUser(id,username){users[id]=username}function processMentionsAndLinks(text){let processed=linkify(text);processed=processed.replace(/(^|\s)(@([a-zA-Z0-9_-]{1,20}))(?![^<]>)/g,(match,space,fullMention,username)=>{return${space}<a href="https://scratch.mit.edu/users/${username}/" style="color:#855cd6;text-decoration:underline;" target="_blank">${fullMention}</a>});return processed}const studioId=window.location.href.split('/')[4];const parentComments="https://api.scratch.mit.edu/studios/"+studioId+"/comments";const element=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2)");let originalPostButton;if(element){element.style.display="none";const parent=element.parentNode;const newDiv=document.createElement("div");newDiv.id="comment-section-placeholder";parent.appendChild(newDiv)}createCommentStructure();fetchAndAppendParentComments();let updateInterval;function initRealTimeCommentUpdate(){updateInterval=setInterval(()=>{fetchAndAppendParentComments();updateOpenReplies();updateAllRelativeTimes()},1000)}initRealTimeCommentUpdate();function submitComment(content,replyTo,destination){const oldSend=XMLHttpRequest.prototype.send;let restored=false;const fallback=setTimeout(()=>{if(!restored){XMLHttpRequest.prototype.send=oldSend;restored=true}},3000);XMLHttpRequest.prototype.send=function(payload){try{const obj=JSON.parse(payload);obj.content=content;obj.parent_id=replyTo||"";obj.commentee_id=destination||"";payload=JSON.stringify(obj)}catch(e){}XMLHttpRequest.prototype.send=oldSend;restored=true;clearTimeout(fallback);return oldSend.call(this,payload)};const op=originalPostButton||document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div.comments-root-reply > div > div > form > div.flex-row.compose-bottom-row > button.button.compose-post");if(op)try{op.click()}catch(e){XMLHttpRequest.prototype.send=oldSend;restored=true;clearTimeout(fallback)}}function createCommentStructure(){const parentElement=document.querySelector("#comment-section-placeholder");if(!parentElement)return;const uniqueId=frc-compose-comment-${Date.now()};const originalIcon=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div > div > a");let href="#",imgSrc="#";if(originalIcon){href=originalIcon.getAttribute("href")||"#";imgSrc=originalIcon.querySelector("img")?.getAttribute("src")||"#"}const newComment=document.createElement("div");newComment.classList.add("comments-root-reply");newComment.innerHTML=<div class="flex-row comment compose-row"><a href="${href}"><img class="avatar" src="${imgSrc}" alt="User Icon"></a><div class="flex-row compose-comment column"><form class="full-width-form"><div class="form-group row textarea-row no-label compose-input compose-valid"><div class="col-sm-offset-3 col-sm-9 grow"><textarea class="inplace-textarea" name="compose-comment" id="${uniqueId}" rows="3"></textarea></div></div><div class="flex-row compose-bottom-row"><button class="button compose-post"><span>投稿する</span></button><button class="button compose-cancel"><span>キャンセル</span></button><span class="compose-limit compose-valid"><span></span></span></div></form></div></div>;parentElement.appendChild(newComment);const customTextarea=newComment.querySelector("textarea");const originalTextarea=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div.comments-root-reply > div > div > form textarea.inplace-textarea");const postButton=newComment.querySelector(".button.compose-post");originalPostButton=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div.comments-root-reply > div > div > form > div.flex-row.compose-bottom-row > button.button.compose-post");if(customTextarea&&originalTextarea){customTextarea.addEventListener("input",()=>{originalTextarea.value=customTextarea.value;originalTextarea.dispatchEvent(new Event("input",{bubbles:true}))});customTextarea.addEventListener("change",()=>{originalTextarea.value=customTextarea.value;originalTextarea.dispatchEvent(new Event("change",{bubbles:true}))})}if(postButton&&originalPostButton){postButton.addEventListener("click",(event)=>{event.preventDefault();const existingError=newComment.querySelector(".compose-error-row");if(existingError)existingError.remove();handlePostButtonClick(postButton,originalPostButton,newComment,customTextarea,originalTextarea,"","")})}applyAvatarSizeFix()}function applyAvatarSizeFix(){if(document.getElementById("frc-avatar-style"))return;const style=document.createElement('style');style.id="frc-avatar-style";style.textContent=img.avatar {width: 40px !important;height: 40px !important;object-fit: cover !important;};document.head.appendChild(style)}function handlePostButtonClick(postButton,originalPostButton,newComment,customTextarea,originalTextarea,parentId,parentAuthorId){if(!postButton||!originalPostButton)return;clearInterval(updateInterval);postButton.querySelector("span").textContent="投稿中...";postButton.disabled=true;const content=(customTextarea&&customTextarea.value!==undefined)?customTextarea.value:(originalTextarea?originalTextarea.value:"");submitComment(content,parentId||"",parentAuthorId||"");let a=0;const interval=setInterval(()=>{try{if(originalPostButton.textContent.includes("...")){a=1}else if(a===1){postButton.querySelector("span").textContent="投稿する";postButton.disabled=false;fetchAndAppendParentComments();updateOpenReplies();updateAllRelativeTimes();initRealTimeCommentUpdate();clearInterval(interval);handleErrorMessages(newComment,originalPostButton,customTextarea,originalTextarea)}}catch(e){postButton.querySelector("span").textContent="投稿する";postButton.disabled=false;initRealTimeCommentUpdate();clearInterval(interval)}},100)}function handleErrorMessages(newComment,originalPostButton,customTextarea,originalTextarea){setTimeout(()=>{const parentLevel3=originalPostButton?.parentElement?.parentElement?.parentElement;let errorExists=false;if(parentLevel3&&parentLevel3.children.length===2){const originalErrorMessage=parentLevel3.children[0];if(originalErrorMessage.classList.contains("compose-error-row")){const errorClone=originalErrorMessage.cloneNode(true);newComment.querySelector(".full-width-form").prepend(errorClone);errorExists=true}}if(!errorExists){if(newComment.classList.contains("comment-reply-row")){newComment.remove()}else{if(customTextarea)customTextarea.value="";if(originalTextarea)originalTextarea.value=""}}},500)}function toggleReplyFormForComment(commentElement){document.querySelectorAll('.comment-reply-row').forEach(form=>form.remove());const replyFormId='reply-form-'+commentElement.id;if(document.getElementById(replyFormId))return;const originalIcon=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div div > a");let replyHref="#",replyImgSrc="#";if(originalIcon){replyHref=originalIcon.getAttribute("href")||"#";replyImgSrc=originalIcon.querySelector("img")?.getAttribute("src")||"#"}const replyForm=document.createElement('div');replyForm.classList.add('flex-row','comment-reply-row');replyForm.id=replyFormId;replyForm.innerHTML=<div class="flex-row comment compose-row"><a href="${replyHref}"><img class="avatar" src="${replyImgSrc}" alt="User Icon"></a><div class="flex-row compose-comment column"><form class="full-width-form"><div class="form-group row textarea-row no-label compose-input compose-valid"><div class="col-sm-offset-3 col-sm-9 grow"><textarea class="inplace-textarea" name="compose-comment" rows="3"></textarea></div></div><div class="flex-row compose-bottom-row"><button type="button" class="button compose-post"><span>投稿する</span></button><button type="button" class="button compose-cancel"><span>キャンセル</span></button><span class="compose-limit compose-valid"><span></span></span></div></form></div></div>;const cancelButton=replyForm.querySelector(".compose-cancel");if(cancelButton){cancelButton.addEventListener("click",(e)=>{e.preventDefault();replyForm.remove()})}const customTextarea=replyForm.querySelector("textarea");const originalTextarea=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div.comments-root-reply > div > div > form textarea.inplace-textarea");if(customTextarea&&originalTextarea){customTextarea.addEventListener("input",()=>{originalTextarea.value=customTextarea.value;originalTextarea.dispatchEvent(new Event("input",{bubbles:true}))});customTextarea.addEventListener("change",()=>{originalTextarea.value=customTextarea.value;originalTextarea.dispatchEvent(new Event("change",{bubbles:true}))})}const postButton=replyForm.querySelector(".compose-post");originalPostButton=document.querySelector("#view > div > div.studio-tabs > div:nth-child(2) > div > div:nth-child(2) > div.comments-root-reply > div > div > form > div.flex-row.compose-bottom-row > button.button.compose-post");if(postButton&&originalPostButton){postButton.addEventListener("click",(e)=>{e.preventDefault();const existingError=replyForm.querySelector(".compose-error-row");if(existingError)existingError.remove();const parentId=commentElement.dataset.commentId;const parentAuthorId=commentElement.dataset.commentAuthor;handlePostButtonClick(postButton,originalPostButton,replyForm,customTextarea,originalTextarea,parentId,parentAuthorId)})}const commentBody=commentElement.querySelector(".comment-body");const commentBubble=commentBody.querySelector(".comment-bubble");if(commentBubble){commentBubble.parentNode.insertBefore(replyForm,commentBubble.nextSibling)}else{commentBody.appendChild(replyForm)}autoFocusReplyInput(replyForm);applyAvatarSizeFix()}function renderAppendedComment(comment){addUser(comment.author.id,comment.author.username);const container=document.createElement("div");container.classList.add("flex-row","comment-container");const commentElement=document.createElement("div");commentElement.classList.add("flex-row","comment");commentElement.id="appended-comment-"+comment.id;commentElement.dataset.commentId=comment.id;commentElement.dataset.commentAuthor=comment.author.id;const userLink=document.createElement("a");userLink.href="/users/"+comment.author.username;const avatar=document.createElement("img");avatar.classList.add("avatar");avatar.src=comment.author.image;avatar.alt=comment.author.username;userLink.appendChild(avatar);const commentBody=document.createElement("div");commentBody.classList.add("flex-row","comment-body","column");const commentTopRow=document.createElement("div");commentTopRow.classList.add("flex-row","comment-top-row");const usernameLink=document.createElement("a");usernameLink.classList.add("username");usernameLink.href="/users/"+comment.author.username;usernameLink.textContent=comment.author.username;commentTopRow.appendChild(usernameLink);const commentBubble=document.createElement("div");commentBubble.classList.add("comment-bubble");const commentContent=document.createElement("span");commentContent.classList.add("comment-content");commentContent.innerHTML=processMentionsAndLinks(decodeHTMLEntities(comment.content));commentBubble.appendChild(commentContent);const commentBottomRow=document.createElement("div");commentBottomRow.classList.add("flex-row","comment-bottom-row");const commentTime=document.createElement("span");commentTime.classList.add("comment-time");const timeSpan=document.createElement("span");timeSpan.dataset.timestamp=comment.datetime_created;timeSpan.textContent=formatRelativeTime(comment.datetime_created);timeSpan.dataset.type="date";commentTime.appendChild(timeSpan);const linkSpan=document.createElement("span");linkSpan.classList.add("comment-link");linkSpan.textContent="リンク";linkSpan.style.marginLeft="8px";linkSpan.style.cursor="pointer";linkSpan.style.color="#855cd6";linkSpan.addEventListener("click",()=>{window.open(https://scratch.mit.edu/studios/${studioId}/comments/#comments-${comment.id},'_blank')});const replyConfirmText=document.createElement("a");replyConfirmText.classList.add("reply-confirm-label");replyConfirmText.textContent="返信を確認";replyConfirmText.style.cursor="pointer";replyConfirmText.style.color="#855cd6";replyConfirmText.addEventListener("click",()=>toggleReplies(commentElement));const replyCount=document.createElement("span");replyCount.classList.add("reply-count");if(comment.reply_count)replyCount.style.fontWeight="bolder";const replyCountOpen=document.createElement("span");replyCountOpen.innerText="(";const replyCounter=document.createElement("span");replyCounter.classList.add("reply-counter");replyCounter.innerText=comment.reply_count;const replyCountClose=document.createElement("span");replyCountClose.innerText=")　";replyCount.appendChild(replyCountOpen);replyCount.appendChild(replyCounter);replyCount.appendChild(replyCountClose);const commentReply=document.createElement("span");commentReply.classList.add("comment-reply");const replyText=document.createElement("span");replyText.textContent="返信";commentReply.appendChild(replyText);commentReply.style.cursor="pointer";commentReply.style.color="#855cd6";commentReply.addEventListener("click",(e)=>{e.preventDefault();toggleReplyFormForComment(commentElement)});const right=document.createElement("span");commentBottomRow.appendChild(commentTime);commentBottomRow.appendChild(right);right.appendChild(linkSpan);right.appendChild(replyConfirmText);right.appendChild(replyCount);right.appendChild(commentReply);commentBubble.appendChild(commentBottomRow);commentBody.appendChild(commentTopRow);commentBody.appendChild(commentBubble);commentElement.appendChild(userLink);commentElement.appendChild(commentBody);container.appendChild(commentElement);return container}function fetchAndAppendParentComments(){const limit=20;const parentCommentsURL=parentComments+?limit=${limit};fetch(parentCommentsURL).then(response=>response.json()).then(comments=>{for(let i=comments.length-1;i>=0;i--){const comment=comments[i];const appendedId="appended-comment-"+comment.id;const e=document.getElementById(appendedId);if(!e){const commentElement=renderAppendedComment(comment);const commentSection=document.getElementById("comment-section-placeholder");if(commentSection){if(commentSection.children.length>=1){commentSection.insertBefore(commentElement,commentSection.children[1])}else{commentSection.appendChild(commentElement)}}}else{const replyCounter=e.querySelector(".reply-counter");if(replyCounter&&Number(replyCounter.innerText)<comment.reply_count){replyCounter.innerText=comment.reply_count;e.querySelector(".reply-count").style.fontWeight="bolder";const repliesContainer=document.getElementById("replies-container-"+comment.id);if(repliesContainer)updateReplies(repliesContainer,comment.id)}}}}).catch(error=>console.error("Error fetching parent comments:",error));applyAvatarSizeFix()}let openReplies=[];function toggleReplies(commentElement){const replyCountEl=commentElement.querySelector(".reply-count");if(replyCountEl)replyCountEl.style.fontWeight="revert";const parentContainer=commentElement.closest(".comment-container");if(!parentContainer)return;const parentId=commentElement.dataset.commentId;const repliesContainerId="replies-container-"+parentId;let repliesContainer=document.getElementById(repliesContainerId);if(repliesContainer){repliesContainer.remove();openReplies=openReplies.filter(c=>c.id!==repliesContainerId);return}const repliesURL=parentComments+/${parentId}/replies?limit=25;fetch(repliesURL).then(response=>response.json()).then(replies=>{repliesContainer=document.createElement("div");repliesContainer.classList.add("flex-row","replies","column");repliesContainer.id=repliesContainerId;replies.forEach(reply=>{const replyElement=renderReplyComment(reply);repliesContainer.appendChild(replyElement)});parentContainer.appendChild(repliesContainer);openReplies.push(repliesContainer);if(openReplies.length>20){const toRemove=openReplies.shift();if(toRemove)toRemove.remove()}applyAvatarSizeFix()}).catch(error=>console.error("Error fetching replies:",error))}function renderReplyComment(reply){addUser(reply.author.id,reply.author.username);const replyContainer=document.createElement("div");replyContainer.classList.add("flex-row","comment");replyContainer.id="comments-"+reply.id;replyContainer.dataset.commentAuthor=reply.author.id;const userLink=document.createElement("a");userLink.href="/users/"+reply.author.username;const avatar=document.createElement("img");avatar.classList.add("avatar");avatar.src=reply.author.image;userLink.appendChild(avatar);const replyBody=document.createElement("div");replyBody.classList.add("flex-row","comment-body","column");const replyTopRow=document.createElement("div");replyTopRow.classList.add("flex-row","comment-top-row");const usernameLink=document.createElement("a");usernameLink.classList.add("username");usernameLink.href="/users/"+reply.author.username;usernameLink.textContent=reply.author.username;replyTopRow.appendChild(usernameLink);const replyBubble=document.createElement("div");replyBubble.classList.add("comment-bubble");const replyContent=document.createElement("span");replyContent.classList.add("comment-content");let textToProcess=decodeHTMLEntities(reply.content);if(reply.commentee_id&&users[reply.commentee_id]){textToProcess="@" + users[reply.commentee_id] + " " + textToProcess}replyContent.innerHTML=processMentionsAndLinks(textToProcess);replyBubble.appendChild(replyContent);const replyBottomRow=document.createElement("div");replyBottomRow.classList.add("flex-row","comment-bottom-row");const replyTime=document.createElement("span");replyTime.classList.add("comment-time");const timeSpan=document.createElement("span");timeSpan.dataset.timestamp=reply.datetime_created;timeSpan.textContent=formatRelativeTime(reply.datetime_created);timeSpan.dataset.type="date";replyTime.appendChild(timeSpan);const linkSpan=document.createElement("span");linkSpan.classList.add("comment-link");linkSpan.textContent="リンク";linkSpan.style.marginLeft="8px";linkSpan.style.cursor="pointer";linkSpan.style.color="#855cd6";linkSpan.addEventListener("click",()=>{window.open(https://scratch.mit.edu/studios/${studioId}/comments/#comments-${reply.id},'_blank')});const replyReply=document.createElement("span");replyReply.classList.add("comment-reply");const replyText=document.createElement("span");replyText.textContent="返信";replyReply.appendChild(replyText);replyReply.style.cursor="pointer";replyReply.style.color="#855cd6";replyReply.addEventListener("click",()=>toggleReplyFormForReply(replyContainer));replyBottomRow.appendChild(replyTime);replyBottomRow.appendChild(linkSpan);replyBottomRow.appendChild(replyReply);replyBubble.appendChild(replyBottomRow);replyBody.appendChild(replyTopRow);replyBody.appendChild(replyBubble);replyContainer.appendChild(userLink);replyContainer.appendChild(replyBody);return replyContainer}function toggleReplyFormForReply(replyElement){if(!replyElement)return;toggleReplyFormForComment(replyElement)}function updateOpenReplies(){openReplies.forEach(container=>{const parentId=container.id.replace("replies-container-","");const parentEl=container.parentElement.firstElementChild;if(parentEl)parentEl.querySelector(".reply-count").style.fontWeight="revert";const repliesURL=parentComments+/${parentId}/replies?limit=25;fetch(repliesURL).then(response=>response.json()).then(replies=>{replies.forEach(reply=>{const replyIdStr="comments-"+reply.id;if(!container.querySelector(#${replyIdStr})){const replyElement=renderReplyComment(reply);container.appendChild(replyElement)}});applyAvatarSizeFix()}).catch(error=>console.error("Error updating replies:",error))})}function updateReplies(container,parentId){const repliesURL=parentComments+/${parentId}/replies?limit=25;fetch(repliesURL).then(response=>response.json()).then(replies=>{replies.forEach(reply=>{const replyIdStr="comments-"+reply.id;if(!container.querySelector(#${replyIdStr})){const replyElement=renderReplyComment(reply);container.appendChild(replyElement)}});applyAvatarSizeFix()})}function autoFocusReplyInput(replyForm){const textarea=replyForm.querySelector("textarea");if(textarea)setTimeout(()=>{textarea.focus()},0)}function decodeHTMLEntities(text){const textarea=document.createElement('textarea');textarea.innerHTML=text;return textarea.value}function formatRelativeTime(timestamp){const now=new Date();const date=new Date(timestamp);const nowYear=now.getFullYear(),nowMonth=now.getMonth(),nowDate=now.getDate();const dateYear=date.getFullYear(),dateMonth=date.getMonth(),dateDate=date.getDate();const yearDiff=nowYear-dateYear;if(yearDiff>=1){return yearDiff===1?"去年":yearDiff===2?"一昨年":${yearDiff} 年前}const monthDiff=nowMonth-dateMonth;if(monthDiff>=1){return monthDiff===1?"約 1 ヶ月前":${monthDiff} ヶ月前}const dayDiff=Math.floor((now-date)/(1000606024));if(dayDiff>=1){return dayDiff===1?"昨日":dayDiff===2?"一昨日":${dayDiff} 日前}const hourDiff=Math.floor((now-date)/(10006060));if(hourDiff>=1)return${hourDiff} 時間前;const minuteDiff=Math.floor((now-date)/(1000*60));if(minuteDiff>=1)return${minuteDiff} 分前;const secondDiff=Math.floor((now-date)/1000);if(secondDiff>=1)return${secondDiff} 秒前;return"今"}function updateAllRelativeTimes(){document.querySelectorAll('[data-type="date"]').forEach(el=>{const ts=el.dataset.timestamp;if(ts)el.textContent=formatRelativeTime(ts)})}function linkify(text){return text.replace(/(https?://[^\s<>"']+)/g,'$1')}const COMMENTS_PER_LOAD=20;function addLoadMoreButtonSafe(){const section=document.getElementById("comment-section-placeholder");if(!section||document.getElementById("load-more-btn"))return;const wrap=document.createElement("div");wrap.style.textAlign="center";wrap.style.margin="8px 0";const btn=document.createElement("button");btn.id="load-more-btn";btn.type="button";btn.innerHTML="もっと読み込む";btn.style.background="#855cd6";btn.style.color="#fff";btn.style.border="none";btn.style.padding="6px 12px";btn.style.borderRadius="8px";btn.style.cursor="pointer";btn.style.fontWeight="600";btn.addEventListener("click",async(e)=>{e.preventDefault();await loadMoreComments(btn)});wrap.appendChild(btn);section.appendChild(wrap)}async function loadMoreComments(btn){const span=btn.querySelector("span");if(span)span.textContent="読み込み中...";btn.disabled=true;const offset=document.querySelectorAll('[id^="appended-comment-"]').length||0;const url=parentComments+?limit=${COMMENTS_PER_LOAD}&offset=${offset};try{const res=await fetch(url);if(!res.ok)throw new Error("HTTP "+res.status);const comments=await res.json();if(!Array.isArray(comments)||comments.length===0){if(span)span.textContent="これ以上コメントはありません";btn.disabled=true;return}const btnWrap=document.getElementById("load-more-btn")?.parentElement;for(let i=0;i<comments.length;i++){const c=comments[i];if(!c)continue;const appendedId="appended-comment-"+c.id;if(document.getElementById(appendedId))continue;const el=renderAppendedComment(c);if(btnWrap&&btnWrap.parentNode){btnWrap.parentNode.insertBefore(el,btnWrap)}else{document.getElementById("comment-section-placeholder").appendChild(el)}}if(comments.length<COMMENTS_PER_LOAD){if(span)span.textContent="これ以上コメントはありません";btn.disabled=true}else{if(span)span.textContent="もっと読み込む";btn.disabled=false}applyAvatarSizeFix()}catch(err){console.error("load more error:",err);if(span)span.textContent="読み込み失敗";btn.disabled=false;setTimeout(()=>{if(btn&&!btn.disabled)btn.querySelector("span").textContent="もっと読み込む"},1200)}}setTimeout(()=>{addLoadMoreButtonSafe()},0.1);applyAvatarSizeFix();})();
